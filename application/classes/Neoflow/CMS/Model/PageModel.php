<?phpnamespace Neoflow\CMS\Model;use \Neoflow\CMS\Views\FrontendView;use \Neoflow\Framework\ORM\AbstractEntityModel;use \Neoflow\Support\Validation\Validator;use \Neoflow\Framework\ORM\EntityRepository;use function \slugify;class PageModel extends AbstractEntityModel{    /**     * @var string     */    public static $tableName = 'pages';    /**     * @var string     */    public static $primaryKey = 'page_id';    /**     * @var array     */    public static $properties = ['page_id', 'title', 'slug',        'description', 'keywords', 'is_active', 'visibility',        'is_active', 'language_id'];    /**     * Get sections.     *     * @return EntityRepository     */    public function sections()    {        return $this->hasMany('\\Neoflow\\CMS\\Model\\SectionModel', 'page_id');    }    /**     * Get parent page.     *     * @return EntityRepository     */    public function parentPage()    {        return $this->belongsTo('\\Neoflow\\CMS\\Model\\PageModel', 'parent_page_id');    }    /**     * Get parent pages.     *     * @return array     */    public function getParentPages()    {        $parentPages = array();        $page = $this;        while (1) {            $page = $page->parentPage()->fetch();            if ($page) {                $parentPages[] = $page;            } else {                break;            }        }        return $parentPages;    }    /**     * Get url.     *     * @return string     */    public function getUrl()    {        $uriParts = array();        if ($this->position > 1 || $this->parent_page_id !== null) {            $uriParts[] = $this->slug;        }        foreach ($this->getParentPages() as $parentPage) {            $uriParts[] = $parentPage->slug;        }        return \Neoflow\Registry::get('config')->getUrl() . '/' . implode('/', array_reverse($uriParts));    }    /**     * Get child pages.     *     * @return EntityRepository     */    public function childPages()    {        return $this->hasMany('\\Neoflow\\CMS\\Model\\PageModel', 'parent_page_id');    }    /**     * Get language     *     * @return Language     */    public function language()    {        return $this->belongsTo('\\Neoflow\\CMS\\Model\\LanguageModel', 'language_id');    }    /**     * Get navitems     *     * @return Language     */    public function navitems()    {        return $this->hasMany('\\Neoflow\\CMS\\Model\\NavitemModel', 'page_id');    }    /**     * Render to view     *     * @param FrontendView $view     * @return string     */    public function renderToView($view)    {        $view->set('page_title', $this->title);        $sections = $this->sections()            ->orderByAsc('position')            ->fetchAll();        foreach ($sections as $section) {            $content = $section->render($view);            $view->addContentToBlock($section->block, $content);        }        return $view;    }    public function save($validate = true)    {        if (!$this->slug) {            $this->slug = slugify($this->title);        }        return parent::save($validate);    }    /**     * Create and save page     *     * @param array $data     * @return self|bool     */    public static function create($data)    {        // Create page        $page = parent::create($data);        if ($page) {            // Create navitem            NavitemModel::create(array(                'navigation_id' => 1,                'page_id' => $page->id(),                'language_id' => $page->language_id,                'parent_navitem_id' => $page->parent_navitem_id ? : null,            ));            if ($page->module_id) {                // Create section                SectionModel::create(array(                    'page_id' => $page->id(),                    'module_id' => $page->module_id,                    'is_active' => true,                    'block' => 1                ));            }        }        return $page;    }    /**     * Validate setting entity     *     * @return bool     */    public function validate()    {        $validator = new Validator($this->toArray());        $validator            ->required()            ->betweenLength(3, 50)            ->callback(function($title, $page) {                $pages = PageModel::repo()                    ->where('title', '=', $title)                    ->where('page_id', '!=', $page->id())                    ->where('language_id', '=', $page->language_id)                    ->fetchAll();                return (count($pages) === 0);            }, '{0} has to be unique', array($this))            ->set('title', 'Title');        $validator            ->required()            ->set('visibility', 'Visibility');        return $validator->validate();    }    public function delete()    {        $navitem = $this->navitems()->where('navigation_id', '=', 1)->fetch();        $childNavitems = $navitem->childNavitems()->fetchAll();        if ($childNavitems && count($childNavitems) > 0) {            foreach ($childNavitems as $childNavitems) {                $subpage = $childNavitems->page()->fetch();                $subpage->delete();            }        }        $navitems = $this->navitems()->fetchAll();        foreach ($navitems as $navitem) {            $navitem->delete();        }        $sections = $this->sections()->fetchAll();        foreach ($sections as $section) {            $section->delete();        }        return parent::delete();    }}